<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>订单</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" type="text/css" href="../css/mui.min.css" />
		<link rel="stylesheet" type="text/css" href="../css/layout.css" />
		<style>
			.eachOrder {
				background-color: #FFFFFF;
				margin-bottom: 1px;
				padding: 0.2rem;
			}
			
			.huise {
				color: rgb(153, 153, 153);
				font-size: 0.8rem;
			}
			
			.dianpu {
				line-height: 2rem;
				margin-left: 0.5rem;
				font-size: 1.1rem;
			}
			
			.workname {
				display: block;
				width: 6rem;
				height: 2rem;
				overflow: hidden;
				font-weight: bold;
			}
			
			#shopCar {
				position: absolute;
				right: 0.5rem;
				bottom: 1rem;
				width: 1.6rem;
				height: 1.6rem;
			}
			
			#shopCar img {
				width: 1.6rem;
				height: 1.6rem;
			}
			
			#nologin {
				text-align: center;
				margin-top: 12rem;
				padding: 3rem 0rem 3rem 0rem;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" style="background-color: darkred;color: #FFFFFF;">
			<h1 class="mui-title" style="color: #FFFFFF;">我的订单</h1>
			<!--<div id="" class="mui-text-right" style="font-size: 0.8rem;padding-top: 0.7rem;">
				全部订单
			</div>-->
		</header>
		<div class="mui-content">
			<div id="msg"></div>
			<!--<div id="shopCar"><img src="../images/shopCar.png" /></div>-->
		</div>
		<!--mui-content-->
	</body>
	<script src="../js/mui.min.js"></script>
	<script src="../js/domain.js" type="text/javascript" charset="utf-8"></script>
	<script>
		mui.plusReady(function() {
			var self = plus.webview.currentWebview(); //获得当前页面的对象
			var fukuan = "";
			fukuan = self.fukuan;
			if(fukuan != "") {
				dingdan();
			}
		});
		window.addEventListener('myorderrefresh', function() {
			dingdan();
		}, false);

		mui.init({
			swipeBack: true, //启用右滑关闭功能
			pullRefresh: {
				container: "#msg", //下拉刷新容器标识，querySelector能定位的css选择器均可，比如：id、.class等
				down: {
					style: 'circle', //必选，下拉刷新样式，目前支持原生5+ ‘circle’ 样式
					color: '#2BD009', //可选，默认“#2BD009” 下拉刷新控件颜色
					height: '50px', //可选,默认50px.下拉刷新控件的高度,
					range: '100px', //可选 默认100px,控件可下拉拖拽的范围
					offset: '0px', //可选 默认0px,下拉刷新控件的起始位置
					auto: false, //可选,默认false.首次加载自动上拉刷新一次
					callback: pulldownRefresh //必选，刷新函数，根据具体业务来编写，比如通过ajax从服务器获取新数据；
				}
			}
		});

		function dingdan() {

			rh.SesId = checkLogin();
			document.getElementById("msg").innerHTML = "";

			var rb = new Object();
			rb.curPage = 1;
			rb.pageSize = 20;
			rb.qryName = "";
			rb.OrderStatus = "";

			var jn = new Object();
			jn.ReqHead = rh;
			jn.ReqBody = rb;

			var sendData = JSON.stringify(jn);

			mui.ajax(baseUrl + "zdm/AppApi/ShopOrder/GetMyOrders", {
				data: sendData,
				dataType: 'json', //服务器返回json格式数据
				type: 'post', //HTTP请求类型
				timeout: 10000, //超时时间设置为10秒；
				headers: {
					'Content-Type': 'application/json'
				},
				success: function(data) {
					checkCurrentUser(data);
					var result = data.RespBody;

					if(result.Recs.length == 0) {
						document.getElementById("msg").innerHTML += "<div style='color:darkred;margin-top: 12rem;text-align:center;'>你还没有产生订单</div>";
					} else {
						//												var zs = result.Recs[4].state;
						//												var oid = result.Recs[4].id;
						//						alert(zs+"——"+oid);
						for(var i = 0; i < result.Recs.length; i++) {
							var zs = result.Recs[i].state;

							var state = "";
							switch(zs) {
								case 0:
									state = "<input type='button' style='margin-top:1rem;' onclick='zhifu(&quot;" + result.Recs[i].id + "&quot;)' value='等待支付'/><input type='button' style='margin-top:1rem;color:red;border-color:red;' onclick='qx(&quot;" + result.Recs[i].id + "&quot;)' value='取消订单'/>";
									break;
								case 1:
									state = "<input type='button' style='margin-top:1rem;' onclick='tuikuan(&quot;" + result.Recs[i].id + "&quot;)' value='申请退款'/>";
									break;
								case 12:
									state = "正在打包<input type='button' style='margin-top:1rem;' onclick='tuikuan(&quot;" + result.Recs[i].id + "&quot;)' value='申请退款'/>";
									break;
								case 2:
									state = "待取货<input type='button' style='margin-top:1rem;' onclick='tuikuan(&quot;" + result.Recs[i].id + "&quot;)' value='申请退款'/>";
									break;
								case 21:
									state = "正在配送<input type='button' style='margin-top:1rem;' onclick='tuikuan(&quot;" + result.Recs[i].id + "&quot;)' value='申请退款'/>";
									break;
								case 3:
									state = "已送达<input type='button' style='margin-top:1rem;' onclick='tuikuan(&quot;" + result.Recs[i].id + "&quot;)' value='申请退款'/>";
									break;
								case 4:
									state = "<input type='button' style='margin-top:1rem;' onclick='pingjia()' value='待评价'/>";
									break;
								case 5:
									state = "已完成";
									break;
								case 50:
									state = "你已取消订单";
									break;
								case 51:
									state = "商家已取消订单";
									break;
								case 52:
									state = "未接单";
									break;
								case 53:
									state = "停止配送";
									break;
							} //switch
							var sp = result.Recs[i].Detail;
							var ssp = "";
							for(var k = 0; k < sp.length; k++) {
								ssp += "<div><div style='width:13rem;float:left;'>" + sp[k].goods_name + "</div><div style='float:right;'>" + sp[k].COUNT + "份</div><div style='clear:both'></div></div>";
							}
							var crt = result.Recs[i].create_time;
							var shijian = crt.year + "-" + crt.month + "-" + crt.date + "&nbsp;&nbsp;&nbsp;" + crt.hours + ":" + crt.minutes + ":" + crt.seconds;
							document.getElementById("msg").innerHTML += "<div class='eachOrder'><div class='mui-row'><div class='mui-col-sm-9 mui-col-xs-9'><div class='mui-pull-left dianpu'><span style='font-size:0.8rem'>订单号：" + result.Recs[i].id + "&nbsp;&nbsp;&nbsp;&nbsp;" + shijian + "</span><span class='workname'>" + result.Recs[i].work_name + "</span>" + ssp + "运费:" + result.Recs[i].express_money + "<br/><span style='color:red;'>总价：￥" + result.Recs[i].amount + "</span></div></div><div class='mui-col-sm-3 mui-col-xs-3 huise'>" + state + "</div></div><div class='mui-clearfix'></div></div>";
						} //result.Recs
					} //if
				},
				error: function(xhr, type, errorThrown) {
					alert(type);
				}
			}); //ajax
		} //dingdan

		//下拉刷新
		function pulldownRefresh() {
			setTimeout(function() {
				document.getElementById("msg").innerHTML = "";
				dingdan();
				mui('#msg').pullRefresh().endPulldownToRefresh(); //这行代码会隐藏掉 正在加载... 容器
				mui.toast('下拉刷新成功');
			}, 1000);
		} //pulldownRefresh

		function zhifu(OrderId) {
			fnSubmit(OrderId);
		} //zhifu

		//付款
		function fnSubmit(OrderId) {
			var channel = null;
			var title = "zdm";
			mui.plusReady(function() {
				plus.payment.getChannels(function(channels) {
					channel = channels[0];
				}, function(e) {
					mui.toast("获取支付通道失败：" + e.message);
				});
				plus.nativeUI.showWaiting();
				mui.post(baseUrl + "/zdm/Pay/Alipay/GetPayInfo", {
					OrderId: OrderId
				}, function(data) {
					plus.nativeUI.closeWaiting();
					if(data) {
						if(data != "repay") {
							plus.payment.request(channel, data, function(result) {
								//									console.log(JSON.stringify(result));
								//									mui.alert(JSON.stringify(result), title);
								//									mui.alert("付费成功", title);
								mui.toast("付费成功");
							}, function(e) {
								//									console.log(JSON.stringify(e));
								//									alert(JSON.stringify(e));
								//									mui.alert("付费失败", title);
								mui.toast("付费失败");
							});
						} else {
							//								mui.alert("付费失败,该订单已经支付过", title);
							mui.toast("付费失败,该订单已经支付过");
						}
					} else {
						plus.nativeUI.alert("支付失败");
					}
				});
			});
		}
		//付款
		//退款
		function tuikuan(OrderId) {

			rh.SesId = checkLogin();

			var rb = new Object();
			rb.OrderId = OrderId;
			rb.return_reason = "";
			rb.photo_path = "";
			rb.recv_case = 0;
			rb.return_desc = "";

			var jn = new Object();
			jn.ReqHead = rh;
			jn.ReqBody = rb;

			var sendData = JSON.stringify(jn);

			mui.ajax(baseUrl + "zdm/AppApi/RefundOrder/saveRefundOrder", {
				data: sendData,
				dataType: 'json', //服务器返回json格式数据
				type: 'post', //HTTP请求类型
				timeout: 10000, //超时时间设置为10秒；
				headers: {
					'Content-Type': 'application/json'
				},
				success: function(data) {
					checkCurrentUser(data);

					switch(data.RespBody.stat) {
						case 0:
							mui.toast("申请退款失败");
							break;
						case 1:
							mui.toast("申请退款成功");
							break;
						case 2:
							mui.toast("已结算，不可退款");
							break;
					} //switch

				},
				error: function(xhr, type, errorThrown) {
					mui.toast("请重试" + type);
				}

			}); //ajax

			//取消订单
			function qx(OrderId) {
				alert("quxiao");
				rh.SesId = checkLogin();

				var rb = new Object();
				rb.OrderId = OrderId;

				var jn = new Object();
				jn.ReqHead = rh;
				jn.ReqBody = rb;

				var sendData = JSON.stringify(jn);

				mui.ajax(baseUrl + "zdm/AppApi/ShopOrder/CancelOrder", {
					data: sendData,
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 10000, //超时时间设置为10秒；
					headers: {
						'Content-Type': 'application/json'
					},
					success: function(data) {
						checkCurrentUser(data);
						if(data.RespBody.succ == 1) {
							mui.toast("订单已取消");
						} else {
							mui.toast("请重试");
						}
					},
					error: function(xhr, type, errorThrown) {
						mui.toast("请重试" + type);
					}

				}); //ajax
			} //quxiao

		} //退款
	</script>

</html>